# Replit 部署教程

**文档版本**: v1.1  
**创建日期**: 2025-12-30  
**最后更新**: 2025-12-30  
**适用范围**: 飞书文档转换 Markdown 工具

---

## 目录

1. [Replit 简介](#replit-简介)
2. [准备工作](#准备工作)
3. [创建 Replit 项目](#创建-replit-项目)
4. [配置项目](#配置项目)
5. [设置环境变量](#设置环境变量)
6. [运行应用](#运行应用)
7. [访问应用](#访问应用)
8. [常见问题](#常见问题)

---

## Replit 简介

Replit 是一个在线编程平台，提供：
- ✅ 完全免费，无需绑定银行卡
- ✅ 支持 Go 语言
- ✅ 提供 Web 服务托管
- ✅ 自动 HTTPS
- ✅ 持续运行（Always On 功能）
- ✅ 简单易用的界面

---

## 准备工作

### 1. 注册 Replit 账户

1. 访问 https://replit.com
2. 点击 "Sign up" 按钮
3. 使用以下方式注册：
   - Google 账户
   - GitHub 账户
   - 邮箱注册

### 2. 准备飞书应用凭证

确保您有以下信息：
- **FEISHU_APP_ID**: `cli_a6727c4ffc71d00b`
- **FEISHU_APP_SECRET**: `dt7LyzH6HOexxH4z9ssXpghYgE8PIvSI`

---

## 创建 Replit 项目

### 步骤 1: 创建新 Replit

1. 登录 Replit 后，点击左上角的 "+ Create Repl" 按钮

2. 选择模板：
   - 在 "Search for a template" 搜索框中输入 "Go"
   - 选择 "Go" 模板（Go 1.21 或更高版本）

3. 命名项目：
   - Repl Name: `feishu2md`
   - Description: `飞书文档转换 Markdown 工具`

4. 点击 "Create Repl" 按钮

---

## 配置项目

### 步骤 2: 从 GitHub 导入代码

有两种方式导入代码：

#### 方式 1: 使用 Git 克隆（推荐）

在 Replit 的 Shell 中执行：

```bash
# 删除默认的 main.go
rm main.go

# 克隆您的 GitHub 仓库
git clone https://github.com/aramisjiang-wq/feishu2md.git temp

# 将所有文件移动到根目录
mv temp/* .
mv temp/.* . 2>/dev/null || true

# 删除临时目录
rm -rf temp

# 查看项目结构
ls -la
```

#### 方式 2: 手动上传文件

1. 点击左侧的 "Files" 图标
2. 点击 "Upload file" 按钮
3. 上传以下文件：
   - `go.mod`
   - `go.sum`
   - `Dockerfile`
   - `Makefile`
   - `core/` 目录（所有文件）
   - `utils/` 目录（所有文件）
   - `web/` 目录（所有文件）
   - `cmd/` 目录（所有文件）

### 步骤 3: 安装依赖

在 Replit 的 Shell 中执行：

```bash
# 下载 Go 依赖
go mod download

# 验证依赖安装
go mod verify
```

### 步骤 4: 配置 .replit 文件

在 Replit 中创建 `.replit` 配置文件：

```bash
touch .replit
```

编辑 `.replit` 文件，添加以下内容：

```toml
[[run]]
name = "Build and Start Web Server"
command = "go build -o feishu2md4web ./web/*.go && ./feishu2md4web"
```

这个配置文件会自动：
1. 编译 web 应用
2. 启动编译后的应用

### 步骤 5: 编译应用

在 Replit 的 Shell 中执行：

```bash
# 编译 web 应用
go build -o feishu2md4web ./web/*.go

# 验证编译成功
ls -lh feishu2md4web
```

---

## 设置环境变量

### 步骤 6: 配置环境变量

在 Replit 中设置环境变量有两种方式：

#### 方式 1: 使用 .env 文件（推荐）

1. 在 Replit 中创建 `.env` 文件：

```bash
touch .env
```

2. 编辑 `.env` 文件，添加以下内容：

```env
FEISHU_APP_ID=cli_a6727c4ffc71d00b
FEISHU_APP_SECRET=dt7LyzH6HOexxH4z9ssXpghYgE8PIvSI
GIN_MODE=release
PORT=8080
```

#### 方式 2: 使用 Replit 的 Secrets

1. 点击左侧的 "Secrets" 图标（锁形图标）
2. 点击 "New Secret" 按钮
3. 添加以下 secrets：
   - Key: `FEISHU_APP_ID`, Value: `cli_a6727c4ffc71d00b`
   - Key: `FEISHU_APP_SECRET`, Value: `dt7LyzH6HOexxH4z9ssXpghYgE8PIvSI`
   - Key: `GIN_MODE`, Value: `release`
   - Key: `PORT`, Value: `8080`

---

## 运行应用

### 步骤 7: 配置 Replit 运行设置

1. 点击左上角的 "Run" 按钮
2. 点击 "Show" → "Shell" 查看 Shell 输出

### 步骤 8: 启动应用

在 Replit 的 Shell 中执行：

```bash
# 启动 web 应用
./feishu2md4web
```

您应该看到类似的输出：

```
[GIN-debug] [WARNING] Running in "debug" mode. Switch to "release" mode in production.
[GIN-debug] GET    /                         --> main.main.func1 (3 handlers)
[GIN-debug] GET    /health                   --> main.main.func2 (3 handlers)
[GIN-debug] GET    /download                 --> main.downloadHandler (3 handlers)
[GIN-debug] Listening and serving HTTP on 0.0.0.0:8080
```

---

## 访问应用

### 步骤 9: 访问 Web 界面

1. 在 Replit 的 Webview 窗口中，您应该能看到应用界面
2. 或者点击右上角的 "Open in a new tab" 按钮
3. 应用将在新标签页中打开

### 步骤 10: 测试功能

1. 在输入框中输入飞书文档 URL
2. 点击 "Download" 按钮
3. 等待转换完成
4. 下载生成的 Markdown 文件

---

## 常见问题

### 问题 1: 应用无法启动

**症状**: 执行 `./feishu2md4web` 时出现错误

**解决方案**:
```bash
# 重新编译应用
go build -o feishu2md4web ./web/*.go

# 检查文件是否存在
ls -lh feishu2md4web

# 检查文件权限
chmod +x feishu2md4web
```

### 问题 2: 端口被占用

**症状**: 出现 "address already in use" 错误

**解决方案**:
```bash
# 查找占用端口的进程
lsof -i :8080

# 杀死占用端口的进程
kill -9 <PID>
```

### 问题 3: 环境变量未生效

**症状**: 应用无法连接飞书 API

**解决方案**:
```bash
# 检查环境变量
echo $FEISHU_APP_ID
echo $FEISHU_APP_SECRET

# 如果为空，重新设置环境变量
export FEISHU_APP_ID=cli_a6727c4ffc71d00b
export FEISHU_APP_SECRET=dt7LyzH6HOexxH4z9ssXpghYgE8PIvSI
```

### 问题 4: 依赖下载失败

**症状**: `go mod download` 失败

**解决方案**:
```bash
# 清理模块缓存
go clean -modcache

# 重新下载依赖
go mod download

# 如果仍然失败，尝试设置代理
export GOPROXY=https://goproxy.cn,direct
go mod download
```

### 问题 5: 应用无法持续运行

**症状**: 应用在一段时间后自动停止

**解决方案**:
Replit 免费计划的应用会在一段时间无活动后自动休眠。您可以：

1. **升级到付费计划**（Hacker 或 Developer）
2. **使用 Always On 功能**（需要付费）
3. **使用外部监控服务**定期 ping 应用，保持活跃

---

## 高级配置

### 配置自动启动

创建 `.replit` 文件：

```toml
[[run]]
name = "Start Web Server"
command = "./feishu2md4web"
```

### 配置健康检查

在应用中添加健康检查端点：

```go
router.GET("/health", func(c *gin.Context) {
    c.JSON(http.StatusOK, gin.H{
        "status": "ok",
    })
})
```

### 配置日志

修改 `web/main.go`，添加日志配置：

```go
import (
    "log"
    "os"
)

func main() {
    logFile, err := os.OpenFile("app.log", os.O_APPEND|os.O_CREATE|os.O_WRONLY, 0644)
    if err != nil {
        log.Fatal(err)
    }
    defer logFile.Close()
    
    log.SetOutput(logFile)
    
    // ... 其他代码
}
```

---

## 性能优化

### 1. 启用 Gzip 压缩

```go
import "github.com/gin-contrib/gzip"

router.Use(gzip.Gzip(gzip.DefaultCompression))
```

### 2. 配置静态文件缓存

```go
router.Static("/static", "./static")
```

### 3. 限制并发请求

```go
import "golang.org/x/time/rate"

limiter := rate.NewLimiter(10, 20)
router.Use(func(c *gin.Context) {
    if !limiter.Allow() {
        c.JSON(http.StatusTooManyRequests, gin.H{
            "error": "Too many requests",
        })
        c.Abort()
        return
    }
    c.Next()
})
```

---

## 安全建议

1. **不要在代码中硬编码敏感信息**
   - 使用环境变量存储 API 密钥
   - 不要将 `.env` 文件提交到 Git

2. **启用 HTTPS**
   - Replit 自动提供 HTTPS
   - 确保应用只监听 HTTPS 端口

3. **限制访问**
   - 添加认证机制
   - 限制 IP 访问范围

4. **定期更新依赖**
   ```bash
   go get -u ./...
   go mod tidy
   ```

---

## 监控和日志

### 查看应用日志

在 Replit 的 Shell 中：

```bash
# 查看实时日志
tail -f app.log

# 查看最近的日志
tail -n 100 app.log

# 搜索错误日志
grep "ERROR" app.log
```

### 监控应用状态

```bash
# 检查进程是否运行
ps aux | grep feishu2md4web

# 检查端口是否监听
lsof -i :8080

# 检查磁盘使用
df -h
```

---

## 备份和恢复

### 备份项目

```bash
# 创建备份
tar -czf feishu2md-backup-$(date +%Y%m%d).tar.gz .

# 下载备份文件
# 在 Replit 的 Files 窗口中，右键点击备份文件，选择 "Download"
```

### 恢复项目

```bash
# 上传备份文件
# 在 Replit 的 Files 窗口中，点击 "Upload file"

# 解压备份
tar -xzf feishu2md-backup-YYYYMMDD.tar.gz
```

---

## 更新应用

### 从 GitHub 拉取最新代码

```bash
# 拉取最新代码
git pull origin main

# 重新编译
go build -o feishu2md4web ./web/*.go

# 重启应用
# 先停止当前运行的应用（Ctrl+C）
# 然后重新启动
./feishu2md4web
```

---

## 总结

通过本教程，您应该能够：

✅ 在 Replit 上创建 Go 项目  
✅ 从 GitHub 导入代码  
✅ 配置环境变量  
✅ 编译和运行应用  
✅ 访问 Web 界面  
✅ 解决常见问题  

---

## 相关资源

- **Replit 官方文档**: https://docs.replit.com
- **Go 语言官方文档**: https://golang.org/doc/
- **Gin 框架文档**: https://gin-gonic.com/docs/
- **飞书开放平台**: https://open.feishu.cn/document/

---

**最后更新**: 2025-12-30  
**维护者**: AI 开发助手  
**版本**: v1.0
