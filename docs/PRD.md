# 飞书文档转换 Markdown 工具 - 产品需求文档 (PRD)

**文档版本**: v1.0  
**创建日期**: 2026-01-13  
**产品名称**: Feishu2md  
**产品类型**: 开发工具/文档转换工具

---

## 1. 产品概述

### 1.1 产品定位
Feishu2md 是一个将飞书文档转换为 Markdown 格式的工具，支持命令行和 Web 两种使用方式，帮助用户轻松导出飞书文档内容，便于在其他平台使用或进行版本控制。

### 1.2 目标用户
- 开发者：需要将飞书文档转换为 Markdown 格式用于技术文档管理
- 内容创作者：希望将飞书文档发布到支持 Markdown 的平台
- 团队协作者：需要将飞书文档迁移到其他文档管理系统

### 1.3 核心价值
- **格式转换**：准确保留飞书文档的格式和内容
- **图片处理**：支持图片下载和 Base64 嵌入两种方式
- **批量操作**：支持文件夹和知识库批量下载
- **多平台支持**：提供命令行和 Web 两种使用方式

---

## 2. 功能需求

### 2.1 核心功能

#### 2.1.1 文档下载
- **功能描述**：支持下载单个飞书文档为 Markdown 格式
- **支持格式**：
  - 飞书文档
  - 飞书知识库页面
- **输出格式**：Markdown (.md)
- **图片处理**：
  - 方式 1：下载图片到本地文件夹，生成 ZIP 压缩包
  - 方式 2：将图片转换为 Base64 编码嵌入 Markdown 文件（推荐）
  - 方式 3：智能压缩 + WebP 转换（最新功能）
    - 自动调整大图片尺寸（最大宽度 800px）
    - 转换为 WebP 格式（比 JPEG 小 25-35%）
    - 文件体积减少 50-70%
    - 图片质量肉眼几乎无差别

#### 2.1.2 批量下载
- **功能描述**：支持批量下载文件夹或知识库中的所有文档
- **支持范围**：
  - 飞书云空间文件夹
  - 飞书知识库
- **输出组织**：保持原有文件夹结构

#### 2.1.3 格式转换
- **支持的飞书元素**：
  - 标题（H1-H9）
  - 段落文本
  - 列表（有序、无序）
  - 代码块（支持多种语言）
  - 引用块
  - 提示框
  - 待办事项
  - 分割线
  - 图片
  - 表格（包括合并单元格）
  - 公式
  - 网格布局
- **格式优化**：
  - 表格：普通表格使用 Markdown 原生格式，合并单元格使用 HTML 格式
  - 列表：支持多级缩进
  - 引用：去除多余换行
  - 图片：自动添加描述性 alt 文本

### 2.2 Web 界面功能

#### 2.2.1 主页面
- **功能描述**：提供简洁的 Web 界面供用户输入飞书文档链接
- **核心元素**：
  - 文档链接输入框
  - 下载按钮
  - 图片嵌入选项（可选）
  - 健康检查接口

#### 2.2.2 下载处理
- **功能描述**：处理用户下载请求并返回文件
- **处理流程**：
  1. 验证文档链接
  2. 获取文档内容
  3. 转换为 Markdown 格式
  4. 处理图片（下载或嵌入）
  5. 格式化输出
  6. 返回文件下载

#### 2.2.3 进度展示（待实现）
- **功能描述**：在下载过程中展示进度条
- **实现方案**：
  - 使用 WebSocket 或 Server-Sent Events (SSE) 实现实时进度更新
  - 前端显示进度条和当前处理状态
  - 支持取消下载操作

---

## 3. 技术架构

### 3.1 技术栈
- **后端语言**：Go 1.x
- **Web 框架**：Gin
- **飞书 SDK**：lark (github.com/chyroc/lark)
- **Markdown 处理**：lute
- **图片处理**：
  - imaging (github.com/disintegration/imaging) - 图片压缩和尺寸调整
  - webp (github.com/chai2010/webp) - WebP 格式编码
- **前端**：HTML + CSS + JavaScript

### 3.2 核心模块

#### 3.2.1 客户端模块 (core/client.go)
- **功能**：与飞书 API 交互
- **核心方法**：
  - `GetDocxContent`: 获取文档内容
  - `GetWikiNodeInfo`: 获取知识库节点信息
  - `DownloadImage`: 下载图片到本地
  - `DownloadImageBase64`: 下载图片并转换为 Base64（带智能压缩和 WebP 转换）
  - `DownloadImageRaw`: 下载图片为字节数组
  - `compressImage`: 压缩图片（调整尺寸）
  - `encodeToWebP`: 转换为 WebP 格式
  - `processImageForBase64`: 智能图片处理流程

#### 3.2.2 解析器模块 (core/parser.go)
- **功能**：将飞书文档结构转换为 Markdown
- **核心方法**：
  - `ParseDocxContent`: 解析文档内容
  - `ParseDocxBlock`: 解析文档块
  - `ParseDocxBlockTable`: 解析表格
  - `ParseDocxBlockImage`: 解析图片

#### 3.2.3 配置模块 (core/config.go)
- **功能**：管理应用配置
- **配置项**：
  - 飞书 App ID
  - 飞书 App Secret
  - 输出目录
  - 图片目录
  - 是否嵌入图片

#### 3.2.4 Web 模块 (web/)
- **功能**：提供 Web 界面和 API
- **核心文件**：
  - `main.go`: Web 服务器入口
  - `download.go`: 下载处理逻辑
  - `templ/index.templ.html`: 前端界面

### 3.3 部署方案
- **本地部署**：直接运行编译后的可执行文件
- **Docker 部署**：使用 Docker 容器运行
- **云服务部署**：支持 Render 等云平台

---

## 4. 用户流程

### 4.1 命令行使用流程

```
1. 配置飞书 API 凭证
   └─ feishu2md config --appId <id> --appSecret <secret>

2. 下载单个文档
   └─ feishu2md dl <飞书文档链接>

3. 批量下载文件夹
   └─ feishu2md dl --batch <文件夹链接>

4. 批量下载知识库
   └─ feishu2md dl --wiki <知识库设置链接>
```

### 4.2 Web 使用流程

```
1. 访问 Web 界面
   └─ http://localhost:8081

2. 输入飞书文档链接
   └─ 粘贴文档 URL

3. 选择图片处理方式（可选）
   └─ 勾选"嵌入图片"选项

4. 点击下载按钮
   └─ 等待处理完成

5. 获取转换后的文件
   └─ 下载 Markdown 文件或 ZIP 压缩包
```

---

## 5. 非功能需求

### 5.1 性能要求
- 单个文档转换时间：< 10 秒（普通文档）
- 批量下载：支持处理 100+ 文档
- 并发处理：支持多用户同时使用（Web 模式）

### 5.2 可靠性要求
- API 调用失败重试机制
- 错误日志记录
- 健康检查接口

### 5.3 安全性要求
- 飞书 API 凭证安全存储
- 输入参数验证
- 防止恶意请求

### 5.4 兼容性要求
- 支持主流操作系统（Windows、macOS、Linux）
- 支持主流浏览器（Chrome、Firefox、Safari、Edge）

---

## 6. 未来规划

### 6.1 短期规划（1-3 个月）
- [ ] 实现下载进度条功能
- [ ] 支持更多飞书元素类型
- [ ] 优化表格渲染效果
- [ ] 添加自定义样式选项

### 6.2 中期规划（3-6 个月）
- [ ] 支持增量更新
- [ ] 添加文档版本管理
- [ ] 支持自定义 Markdown 模板
- [ ] 提供插件系统

### 6.3 长期规划（6-12 个月）
- [ ] 支持其他文档平台（Notion、语雀等）
- [ ] 提供在线编辑功能
- [ ] 构建文档管理平台
- [ ] 开发移动端应用

---

## 7. 附录

### 7.1 相关文档
- [README.md](../README.md) - 项目说明文档
- [本地部署使用指南](./本地部署使用指南.md) - 部署和配置指南
- [飞书开放平台文档](https://open.feishu.cn/document/) - 飞书 API 文档

### 7.2 技术参考
- [Gin Web 框架](https://gin-gonic.com/)
- [Lark SDK](https://github.com/chyroc/lark)
- [Lute Markdown 引擎](https://github.com/88250/lute)

### 7.3 更新记录
- v1.0 (2026-01-13): 初始版本，完成基础功能梳理

---

**文档维护**：产品团队  
**最后更新**：2026-01-13
