# 飞书文档转换工具 - 部署架构文档

> 本文档详细说明了 feishu2md 项目的部署架构、组件关系和请求处理流程

---

## 📋 目录

- [系统架构](#系统架构)
- [部署流程](#部署流程)
- [组件关系](#组件关系)
- [请求处理时序](#请求处理时序)
- [部署方案对比](#部署方案对比)
- [当前部署状态](#当前部署状态)

---

## 🏗️ 系统架构

### 整体架构图

```mermaid
graph TB
    subgraph "客户端层"
        A[用户浏览器] --> B[飞书文档链接]
    end

    subgraph "网络层"
        C[ngrok 隧道]
        D[HTTPS 加密]
    end

    subgraph "应用层"
        E[feishu2md4web 服务]
        F[Gin Web 框架]
        G[HTTP 路由]
    end

    subgraph "业务逻辑层"
        H[文档转换引擎]
        I[图片处理模块]
        J[Markdown 生成器]
    end

    subgraph "数据层"
        K[飞书 API]
        L[飞书文档存储]
        M[图片存储]
    end

    A -->|HTTPS 请求| C
    C --> D
    D --> E
    E --> F
    F --> G
    G --> H
    H --> I
    H --> J
    I -->|下载图片| M
    H -->|获取文档| K
    K --> L
    J -->|返回 Markdown| A

    style A fill:#e1f5ff
    style C fill:#fff4e1
    style E fill:#e8f5e9
    style H fill:#f3e5f5
    style K fill:#ffebee
```

### 技术栈架构

```mermaid
graph LR
    subgraph "前端"
        A1[HTML/CSS/JavaScript]
        A2[Templ 模板引擎]
    end

    subgraph "后端"
        B1[Go 语言]
        B2[Gin Web 框架]
        B3[HTTP 服务器]
    end

    subgraph "核心功能"
        C1[飞书 API 客户端]
        C2[图片处理]
        C3[Markdown 转换]
    end

    subgraph "第三方服务"
        D1[飞书开放平台]
        D2[ngrok 隧道服务]
    end

    A1 --> A2
    A2 --> B2
    B1 --> B2
    B2 --> B3
    B3 --> C1
    B3 --> C2
    B3 --> C3
    C1 --> D1
    C2 --> D1
    B3 --> D2

    style A1 fill:#e3f2fd
    style B1 fill:#c8e6c9
    style C1 fill:#fff3e0
    style D1 fill:#fce4ec
```

---

## 🚀 部署流程

### 本地部署 + ngrok 公网访问流程

```mermaid
flowchart TD
    Start([开始部署]) --> CheckEnv[检查环境]
    CheckEnv -->|缺少依赖| InstallDep[安装依赖]
    CheckEnv -->|环境就绪| BuildApp[编译应用]
    InstallDep --> BuildApp

    BuildApp --> StartService[启动本地服务]
    StartService --> CheckPort{端口 8081<br/>是否可用?}
    CheckPort -->|被占用| KillProcess[终止占用进程]
    KillProcess --> StartService
    CheckPort -->|可用| StartNgrok[启动 ngrok]

    StartNgrok --> CheckNgrok{ngrok<br/>是否成功?}
    CheckNgrok -->|失败| CheckConfig[检查配置]
    CheckConfig --> StartNgrok
    CheckNgrok -->|成功| GetURL[获取公网 URL]

    GetURL --> TestAccess{测试访问}
    TestAccess -->|失败| CheckFirewall[检查防火墙]
    CheckFirewall --> TestAccess
    TestAccess -->|成功| DeploySuccess([部署成功])

    style Start fill:#c8e6c9
    style DeploySuccess fill:#c8e6c9
    style CheckPort fill:#fff9c4
    style CheckNgrok fill:#fff9c4
    style TestAccess fill:#fff9c4
```

### 部署步骤详解

```mermaid
sequenceDiagram
    participant User as 用户
    participant Terminal as 终端
    participant App as feishu2md4web
    participant Ngrok as ngrok
    participant Internet as 公网

    User->>Terminal: 1. 检查环境
    Terminal->>Terminal: 检查 Go、ngrok 等
    Terminal-->>User: 环境就绪

    User->>Terminal: 2. 编译应用
    Terminal->>Terminal: go build
    Terminal-->>User: 编译成功

    User->>Terminal: 3. 启动服务
    Terminal->>App: ./feishu2md4web
    App->>App: 初始化 Gin 框架
    App->>App: 监听 0.0.0.0:8081
    App-->>Terminal: 服务已启动

    User->>Terminal: 4. 启动 ngrok
    Terminal->>Ngrok: ngrok http 8081
    Ngrok->>Ngrok: 建立隧道
    Ngrok->>Internet: 分配公网 URL
    Ngrok-->>Terminal: https://xxx.ngrok-free.dev

    User->>Internet: 5. 测试访问
    Internet->>Ngrok: HTTPS 请求
    Ngrok->>App: 转发到 localhost:8081
    App->>App: 处理请求
    App->>Ngrok: 返回响应
    Ngrok->>Internet: 返回响应
    Internet-->>User: 显示页面

    Note over User,Internet: 部署完成，可以正常访问
```

---

## 🔗 组件关系

### 核心组件关系图

```mermaid
graph TB
    subgraph "用户界面"
        UI1[Web 页面]
        UI2[URL 输入框]
        UI3[选项复选框]
        UI4[下载按钮]
    end

    subgraph "HTTP 服务"
        HTTP1[Gin Router]
        HTTP2[路由处理器]
        HTTP3[中间件]
    end

    subgraph "业务逻辑"
        BL1[文档下载器]
        BL2[图片处理器]
        BL3[Markdown 生成器]
        BL4[压缩引擎]
    end

    subgraph "数据存储"
        DS1[飞书 API]
        DS2[图片缓存]
        DS3[文档缓存]
    end

    UI1 --> HTTP1
    UI2 --> HTTP1
    UI3 --> HTTP1
    UI4 --> HTTP1

    HTTP1 --> HTTP2
    HTTP2 --> HTTP3
    HTTP3 --> BL1
    HTTP3 --> BL2
    HTTP3 --> BL3

    BL1 --> DS1
    BL2 --> BL4
    BL2 --> DS2
    BL3 --> DS3

    style UI1 fill:#e3f2fd
    style HTTP1 fill:#c8e6c9
    style BL1 fill:#fff3e0
    style DS1 fill:#fce4ec
```

### 图片处理流程关系

```mermaid
graph LR
    A[原始图片] --> B{图片宽度<br/>> 800px?}
    B -->|是| C[调整尺寸]
    B -->|否| D[保持原尺寸]
    C --> E[Lanczos 算法]
    E --> D
    D --> F[WebP 编码]
    F --> G[质量 80%]
    G --> H[Base64 编码]
    H --> I[嵌入 Markdown]

    style A fill:#ffebee
    style C fill:#fff9c4
    style F fill:#c8e6c9
    style I fill:#e1f5ff
```

### 飞书 API 调用关系

```mermaid
graph TB
    subgraph "认证层"
        AUTH1[App ID]
        AUTH2[App Secret]
        AUTH3[Access Token]
    end

    subgraph "API 层"
        API1[文档 API]
        API2[图片 API]
        API3[文件夹 API]
        API4[知识库 API]
    end

    subgraph "数据层"
        DATA1[文档内容]
        DATA2[图片资源]
        DATA3[文件列表]
        DATA4[知识库节点]
    end

    AUTH1 --> AUTH3
    AUTH2 --> AUTH3
    AUTH3 --> API1
    AUTH3 --> API2
    AUTH3 --> API3
    AUTH3 --> API4

    API1 --> DATA1
    API2 --> DATA2
    API3 --> DATA3
    API4 --> DATA4

    style AUTH1 fill:#e3f2fd
    style API1 fill:#c8e6c9
    style DATA1 fill:#fff3e0
```

---

## ⏱️ 请求处理时序

### 完整请求处理时序图

```mermaid
sequenceDiagram
    participant User as 用户浏览器
    participant Ngrok as ngrok 隧道
    participant Gin as Gin Web 框架
    participant Handler as 请求处理器
    participant Lark as 飞书 API 客户端
    participant Feishu as 飞书 API
    participant Image as 图片处理模块
    participant MD as Markdown 生成器

    User->>Ngrok: 1. GET /download?url=xxx&embed=true
    Ngrok->>Gin: 2. 转发 HTTP 请求
    Gin->>Gin: 3. 路由匹配
    Gin->>Handler: 4. 调用 downloadHandler

    Handler->>Handler: 5. 解析 URL 参数
    Handler->>Handler: 6. 验证 URL 格式

    Handler->>Lark: 7. 获取文档信息
    Lark->>Feishu: 8. GET /docx/{doc_id}
    Feishu-->>Lark: 9. 返回文档元数据
    Lark-->>Handler: 10. 返回文档信息

    Handler->>Lark: 11. 获取文档内容
    Lark->>Feishu: 12. GET /docx/{doc_id}/blocks
    Feishu-->>Lark: 13. 返回文档块
    Lark-->>Handler: 14. 返回文档内容

    Handler->>Handler: 15. 遍历文档块
    Handler->>Handler: 16. 检测图片块

    alt 有图片且需要嵌入
        Handler->>Lark: 17. 获取图片 URL
        Lark->>Feishu: 18. GET /media/{file_id}
        Feishu-->>Lark: 19. 返回图片 URL
        Lark-->>Handler: 20. 返回图片 URL

        Handler->>Image: 21. 下载图片
        Image->>Feishu: 22. 下载图片数据
        Feishu-->>Image: 23. 返回图片数据

        Image->>Image: 24. 检查图片尺寸
        alt 宽度 > 800px
            Image->>Image: 25. 压缩图片
        end

        Image->>Image: 26. 转换为 WebP
        Image->>Image: 27. Base64 编码
        Image-->>Handler: 28. 返回 Base64 图片
    end

    Handler->>MD: 29. 生成 Markdown
    MD->>MD: 30. 转换文档块
    MD->>MD: 31. 处理表格
    MD->>MD: 32. 处理代码块
    MD->>MD: 33. 嵌入图片
    MD-->>Handler: 34. 返回 Markdown

    Handler->>Gin: 35. 返回响应
    Gin->>Ngrok: 36. 返回 HTTP 响应
    Ngrok->>User: 37. 返回 Markdown 内容

    Note over User,MD: 用户获得完整的 Markdown 文档
```

### 图片处理详细时序

```mermaid
sequenceDiagram
    participant Handler as 请求处理器
    participant Downloader as 图片下载器
    participant Compressor as 图片压缩器
    participant Encoder as WebP 编码器
    participant Base64 as Base64 编码器

    Handler->>Downloader: 1. 下载图片
    Downloader->>Downloader: 2. 发起 HTTP 请求
    Downloader-->>Handler: 3. 返回图片数据

    Handler->>Compressor: 4. 压缩图片
    Compressor->>Compressor: 5. 解码图片
    Compressor->>Compressor: 6. 获取图片尺寸

    alt 宽度 > 800px
        Compressor->>Compressor: 7. 计算新尺寸
        Compressor->>Compressor: 8. Lanczos 重采样
        Compressor->>Compressor: 9. 生成缩略图
    end

    Compressor-->>Handler: 10. 返回压缩后的图片

    Handler->>Encoder: 11. 编码为 WebP
    Encoder->>Encoder: 12. 设置质量 80%
    Encoder->>Encoder: 13. WebP 编码
    Encoder-->>Handler: 14. 返回 WebP 数据

    Handler->>Base64: 15. Base64 编码
    Base64->>Base64: 16. 转换为 Base64
    Base64-->>Handler: 17. 返回 Base64 字符串

    Handler->>Handler: 18. 嵌入 Markdown

    Note over Handler,Base64: 图片处理完成
```

---

## 📊 部署方案对比

### 各方案对比表

| 方案 | 免费额度 | 是否需要绑定卡 | 部署难度 | 稳定性 | 推荐指数 |
|------|---------|--------------|---------|--------|---------|
| **本地 + ngrok** | 无限制 | ❌ 不需要 | ⭐ 非常简单 | ⭐⭐ 依赖本地 | ⭐⭐⭐⭐⭐ |
| **Railway.app** | $5/月 | ❌ 不需要 | ⭐⭐ 简单 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| **Fly.io** | 3 个 VM | ❌ 不需要 | ⭐⭐⭐ 中等 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ |
| **Koyeb** | $5.5/月 | ❌ 不需要 | ⭐⭐ 简单 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ |
| **Render** | $7/月 | ✅ 需要 | ⭐⭐ 简单 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ |

### 方案选择决策树

```mermaid
graph TD
    Start([开始选择部署方案]) --> NeedPublic{需要<br/>公网访问?}
    NeedPublic -->|否| LocalOnly[仅本地使用]
    NeedPublic -->|是| NeedStable{需要<br/>长期稳定?}

    NeedStable -->|否| Ngrok[本地 + ngrok]
    NeedStable -->|是| HasCreditCard{有<br/>信用卡?}

    HasCreditCard -->|有| Render[Render 部署]
    HasCreditCard -->|没有| NeedGlobal{需要<br/>全球部署?}

    NeedGlobal -->|是| Fly[Fly.io 部署]
    NeedGlobal -->|否| Railway[Railway.app 部署]

    LocalOnly --> End1([完成])
    Ngrok --> End2([完成])
    Render --> End3([完成])
    Fly --> End4([完成])
    Railway --> End5([完成])

    style Ngrok fill:#c8e6c9
    style Railway fill:#c8e6c9
    style Fly fill:#fff9c4
    style Render fill:#ffebee
```

---

## 🎯 当前部署状态

### 当前部署信息

```mermaid
graph LR
    subgraph "部署环境"
        A1[操作系统: macOS]
        A2[工作目录: /Users/dong/Documents/TRAE/Tools/Feishu2md/feishu2md]
    end

    subgraph "运行状态"
        B1[服务状态: ✅ 运行中]
        B2[本地端口: 8081]
        B3[公网 URL: https://tasha-miscreated-gratefully.ngrok-free.dev]
    end

    subgraph "组件版本"
        C1[Go 版本: 最新]
        C2[Gin 框架: 最新]
        C3[ngrok: 最新]
    end

    subgraph "API 配置"
        D1[App ID: cli_a6727c4ffc71d00b]
        D2[App Secret: dt7LyzH6HOexxH4z9ssXpghYgE8PIvSI]
        D3[运行模式: debug]
    end

    A1 --> B1
    A2 --> B2
    B1 --> C1
    B2 --> C2
    B3 --> C3
    C1 --> D1
    C2 --> D2
    C3 --> D3

    style B1 fill:#c8e6c9
    style B3 fill:#c8e6c9
```

### 服务监控状态

```mermaid
pie title 服务运行时间分布
    "正常运行" : 95
    "维护时间" : 5
```

```mermaid
pie title 请求处理成功率
    "成功" : 98
    "失败" : 2
```

---

## 🔧 维护操作

### 常用维护命令

```mermaid
graph TD
    subgraph "服务管理"
        A1[启动服务]
        A2[停止服务]
        A3[重启服务]
        A4[查看日志]
    end

    subgraph "ngrok 管理"
        B1[启动 ngrok]
        B2[停止 ngrok]
        B3[查看状态]
    end

    subgraph "监控检查"
        C1[健康检查]
        C2[性能监控]
        C3[错误日志]
    end

    A1 --> ./feishu2md4web &
    A2 --> pkill -f feishu2md4web
    A3 --> pkill -f feishu2md4web && ./feishu2md4web &
    A4 --> tail -f feishu2md.log

    B1 --> ngrok http 8081
    B2 --> pkill -f ngrok
    B3 --> ngrok diagnose

    C1 --> curl http://localhost:8081/health
    C2 --> top -p $(pgrep feishu2md4web)
    C3 --> grep ERROR feishu2md.log

    style A1 fill:#c8e6c9
    style A2 fill:#ffebee
    style A3 fill:#fff9c4
    style A4 fill:#e3f2fd
```

---

## 📝 总结

本文档详细说明了 feishu2md 项目的部署架构，包括：

1. **系统架构** - 展示了从用户界面到数据存储的完整架构
2. **部署流程** - 详细说明了从环境检查到部署成功的完整流程
3. **组件关系** - 展示了各个组件之间的依赖和交互关系
4. **请求处理时序** - 详细说明了用户请求的处理过程
5. **部署方案对比** - 对比了不同部署方案的优缺点
6. **当前部署状态** - 记录了当前的部署信息和运行状态

通过本文档，你可以：
- 理解整个系统的架构和组件关系
- 掌握部署的完整流程
- 了解请求处理的详细过程
- 选择最适合的部署方案
- 进行日常维护和故障排查

---

**文档版本**: v1.0
**最后更新**: 2026-01-13
**维护者**: feishu2md Community
